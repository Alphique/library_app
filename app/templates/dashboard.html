<!-- app/templates/dashboard.html -->
{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Welcome Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 fw-bold text-primary mb-2">Welcome back, {{ current_user.username }}! ðŸ‘‹</h1>
                    <p class="text-muted mb-0">Here's what's happening with your library today</p>
                </div>
                <div class="text-end">
                    <small class="text-muted">Last login: {{ current_user.last_login.strftime('%b %d, %Y at %H:%M') if current_user.last_login else 'First time!' }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <!-- Wallet Balance -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card card-gradient-primary border-0 shadow-hover">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-white-50 mb-2">Wallet Balance</h6>
                            <h2 class="text-white mb-0">${{ "%.2f"|format(wallet.balance) if wallet else "0.00" }}</h2>
                            <small class="text-white-50">Available funds</small>
                        </div>
                        <div class="icon-shape bg-white bg-opacity-20 rounded-circle p-3">
                            <i class="fas fa-wallet text-white fs-4"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <a href="{{ url_for('payments.wallet') }}" class="btn btn-light btn-sm w-100">
                            <i class="fas fa-plus me-1"></i>Add Funds
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- My Books -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card card-gradient-success border-0 shadow-hover">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-white-50 mb-2">My Books</h6>
                            <h2 class="text-white mb-0">{{ user_books|length }}</h2>
                            <small class="text-white-50">Total uploaded</small>
                        </div>
                        <div class="icon-shape bg-white bg-opacity-20 rounded-circle p-3">
                            <i class="fas fa-book text-white fs-4"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <a href="{{ url_for('books.my_books') }}" class="btn btn-light btn-sm w-100">
                            <i class="fas fa-eye me-1"></i>View All
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transactions -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card card-gradient-info border-0 shadow-hover">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-white-50 mb-2">Transactions</h6>
                            <h2 class="text-white mb-0">{{ user_transactions|length }}</h2>
                            <small class="text-white-50">All time</small>
                        </div>
                        <div class="icon-shape bg-white bg-opacity-20 rounded-circle p-3">
                            <i class="fas fa-exchange-alt text-white fs-4"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <a href="{{ url_for('payments.transaction_history') }}" class="btn btn-light btn-sm w-100">
                            <i class="fas fa-history me-1"></i>View History
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Rentals -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card card-gradient-warning border-0 shadow-hover">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-white-50 mb-2">Active Rentals</h6>
                            <h2 class="text-white mb-0">{{ user_transactions|selectattr("transaction_type", "equalto", "rental")|list|length }}</h2>
                            <small class="text-white-50">Currently reading</small>
                        </div>
                        <div class="icon-shape bg-white bg-opacity-20 rounded-circle p-3">
                            <i class="fas fa-clock text-white fs-4"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <a href="{{ url_for('payments.transaction_history') }}" class="btn btn-light btn-sm w-100">
                            <i class="fas fa-list me-1"></i>Manage
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Quick Actions & Recent Activity -->
        <div class="col-xl-8 mb-4">
            <div class="row">
                <!-- Quick Actions -->
                <div class="col-md-6 mb-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-transparent border-0 py-3">
                            <h5 class="fw-bold mb-0 text-primary">
                                <i class="fas fa-bolt me-2"></i>Quick Actions
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-3">
                                <a href="{{ url_for('books.upload') }}" class="btn btn-primary btn-lg py-3 fw-bold">
                                    <i class="fas fa-cloud-upload-alt me-2"></i>
                                    Upload New Book
                                </a>
                                <a href="{{ url_for('books.catalog') }}" class="btn btn-outline-primary btn-lg py-3 fw-bold">
                                    <i class="fas fa-search me-2"></i>
                                    Browse Catalog
                                </a>
                                <a href="{{ url_for('payments.wallet') }}" class="btn btn-outline-success btn-lg py-3 fw-bold">
                                    <i class="fas fa-wallet me-2"></i>
                                    Manage Wallet
                                </a>
                                <a href="{{ url_for('books.my_books') }}" class="btn btn-outline-info btn-lg py-3 fw-bold">
                                    <i class="fas fa-book-open me-2"></i>
                                    My Library
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="col-md-6 mb-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-header bg-transparent border-0 py-3">
                            <h5 class="fw-bold mb-0 text-success">
                                <i class="fas fa-chart-line me-2"></i>Recent Activity
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if user_transactions %}
                                <div class="timeline">
                                    {% for transaction in user_transactions[:6] %}
                                    <div class="timeline-item {% if loop.first %}active{% endif %}">
                                        <div class="timeline-marker bg-{{ 'success' if transaction.transaction_type == 'purchase' else 'info' }}"></div>
                                        <div class="timeline-content">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="mb-1 fw-bold">{{ transaction.book.title|truncate(25) }}</h6>
                                                    <small class="text-muted">{{ transaction.transaction_type|title }} â€¢ {{ transaction.created_at.strftime('%b %d') }}</small>
                                                </div>
                                                <span class="badge bg-{{ 'success' if transaction.status == 'completed' else 'warning' }} rounded-pill">
                                                    ${{ "%.2f"|format(transaction.amount) }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="text-center mt-3">
                                    <a href="{{ url_for('payments.transaction_history') }}" class="btn btn-sm btn-outline-success">
                                        <i class="fas fa-history me-1"></i>View All Activity
                                    </a>
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-inbox fs-1 text-muted mb-3"></i>
                                    <p class="text-muted">No recent activity</p>
                                    <a href="{{ url_for('books.catalog') }}" class="btn btn-primary">
                                        <i class="fas fa-rocket me-1"></i>Start Exploring
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Recent Books -->
            <div class="row">
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-transparent border-0 py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="fw-bold mb-0 text-info">
                                    <i class="fas fa-bookmark me-2"></i>My Recent Books
                                </h5>
                                <a href="{{ url_for('books.my_books') }}" class="btn btn-sm btn-outline-info">View All</a>
                            </div>
                        </div>
                        <div class="card-body">
                            {% if user_books %}
                                <div class="row g-3">
                                    {% for book in user_books[:4] %}
                                    <div class="col-xl-3 col-lg-6">
                                        <div class="card border-0 shadow-sm-hover h-100">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <span class="badge bg-{{ 'success' if book.status == 'available' else 'warning' }} rounded-pill">
                                                        {{ book.status|title }}
                                                    </span>
                                                    {% if book.price > 0 %}
                                                    <span class="fw-bold text-success">${{ "%.2f"|format(book.price) }}</span>
                                                    {% endif %}
                                                </div>
                                                <h6 class="card-title fw-bold text-dark mb-2">{{ book.title|truncate(30) }}</h6>
                                                <p class="card-text text-muted small mb-3">{{ book.author }}</p>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <small class="text-muted">{{ book.created_at.strftime('%b %d') }}</small>
                                                    <a href="{{ url_for('books.book_detail', book_id=book.book_id) }}" 
                                                       class="btn btn-sm btn-outline-primary">
                                                        View
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-books fs-1 text-muted mb-3"></i>
                                    <h6 class="text-muted mb-2">No books uploaded yet</h6>
                                    <p class="text-muted small mb-3">Start building your library by uploading your first book</p>
                                    <a href="{{ url_for('books.upload') }}" class="btn btn-primary">
                                        <i class="fas fa-plus me-1"></i>Upload First Book
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar - Stats & Progress -->
        <div class="col-xl-4 mb-4">
            <!-- Reading Progress -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="fw-bold mb-0 text-warning">
                        <i class="fas fa-trophy me-2"></i>Reading Stats
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="progress-circle mx-auto mb-3" data-percentage="65">
                            <span class="progress-circle-value fw-bold">65%</span>
                        </div>
                        <h6 class="fw-bold mb-1">Monthly Reading Goal</h6>
                        <small class="text-muted">13 of 20 books completed</small>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-item text-center">
                            <div class="stat-value text-primary fw-bold">{{ user_books|length }}</div>
                            <div class="stat-label text-muted small">Books Uploaded</div>
                        </div>
                        <div class="stat-item text-center">
                            <div class="stat-value text-success fw-bold">{{ user_transactions|selectattr("transaction_type", "equalto", "purchase")|list|length }}</div>
                            <div class="stat-label text-muted small">Books Purchased</div>
                        </div>
                        <div class="stat-item text-center">
                            <div class="stat-value text-info fw-bold">{{ user_transactions|selectattr("transaction_type", "equalto", "rental")|list|length }}</div>
                            <div class="stat-label text-muted small">Books Rented</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 py-3">
                    <h5 class="fw-bold mb-0 text-purple">
                        <i class="fas fa-chart-pie me-2"></i>Quick Stats
                    </h5>
                </div>
                <div class="card-body">
                    <div class="quick-stats">
                        <div class="quick-stat-item">
                            <i class="fas fa-dollar-sign text-success"></i>
                            <div>
                                <strong>Total Spent</strong>
                                <span>${{ "%.2f"|format(user_transactions|sum(attribute='amount')) }}</span>
                            </div>
                        </div>
                        <div class="quick-stat-item">
                            <i class="fas fa-calendar text-primary"></i>
                            <div>
                                <strong>Member Since</strong>
                                <span>{{ current_user.created_at.strftime('%b %Y') }}</span>
                            </div>
                        </div>
                        <div class="quick-stat-item">
                            <i class="fas fa-star text-warning"></i>
                            <div>
                                <strong>Account Level</strong>
                                <span>Reader</span>
                            </div>
                        </div>
                        <div class="quick-stat-item">
                            <i class="fas fa-award text-info"></i>
                            <div>
                                <strong>Reading Streak</strong>
                                <span>7 days</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Gradient backgrounds for cards */
.card-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.card-gradient-success {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.card-gradient-info {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.card-gradient-warning {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

/* Hover effects */
.shadow-hover {
    transition: all 0.3s ease;
}

.shadow-hover:hover {
    transform: translateY(-5px);
    box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.175) !important;
}

.shadow-sm-hover {
    transition: all 0.3s ease;
}

.shadow-sm-hover:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

/* Icon shapes */
.icon-shape {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Timeline */
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
    padding: 15px 0;
    border-left: 2px solid #e9ecef;
}

.timeline-item:last-child {
    border-left: 2px solid transparent;
}

.timeline-marker {
    position: absolute;
    left: -30px;
    top: 20px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid #fff;
}

.timeline-item.active .timeline-marker {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
}

/* Progress circle */
.progress-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: conic-gradient(#ffd700 65%, #e9ecef 0);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.progress-circle::before {
    content: '';
    width: 60px;
    height: 60px;
    background: white;
    border-radius: 50%;
    position: absolute;
}

.progress-circle-value {
    position: relative;
    z-index: 1;
    font-size: 0.9rem;
}

/* Stats grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-top: 20px;
}

.stat-item {
    padding: 10px;
}

.stat-value {
    font-size: 1.5rem;
    line-height: 1.2;
}

.stat-label {
    font-size: 0.75rem;
}

/* Quick stats */
.quick-stats {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.quick-stat-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
}

.quick-stat-item i {
    font-size: 1.2rem;
    width: 30px;
}

.quick-stat-item div {
    flex: 1;
}

.quick-stat-item strong {
    display: block;
    font-size: 0.8rem;
    color: #6c757d;
}

.quick-stat-item span {
    display: block;
    font-size: 1rem;
    font-weight: 600;
    color: #495057;
}

/* Text colors */
.text-purple {
    color: #6f42c1 !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .icon-shape {
        width: 50px;
        height: 50px;
    }
    
    .icon-shape i {
        font-size: 1.2rem !important;
    }
}
</style>

<script>
// Add interactive elements
document.addEventListener('DOMContentLoaded', function() {
    // Add loading animations to cards
    const cards = document.querySelectorAll('.shadow-hover, .shadow-sm-hover');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('animate__animated', 'animate__fadeInUp');
    });

    // Add click effects to buttons
    const buttons = document.querySelectorAll('.btn');
    buttons.forEach(button => {
        button.addEventListener('click', function(e) {
            if (!this.classList.contains('disabled')) {
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading...';
                this.classList.add('disabled');
                
                setTimeout(() => {
                    this.innerHTML = originalText;
                    this.classList.remove('disabled');
                }, 2000);
            }
        });
    });

    // Update progress circle animation
    const progressCircle = document.querySelector('.progress-circle');
    if (progressCircle) {
        const percentage = progressCircle.getAttribute('data-percentage');
        progressCircle.style.background = `conic-gradient(#ffd700 ${percentage}%, #e9ecef 0)`;
    }
});
</script>
{% endblock %}