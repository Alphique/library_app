{% extends "base.html" %}

{% block content %}
<div class="bg-system">
    <div class="bg-image" style="background-image: url('{{ url_for('static', filename='photos/cuzlib.png') }}');"></div>
    <div class="bg-overlay-glass"></div>
</div>

<div class="container-fluid py-4 dashboard-relative">
    <div class="row mb-4">
        <div class="col-12">
            <div class="header-glass-card p-4">
                <div class="row align-items-center">
                    <div class="col-md-8 d-flex align-items-center">
                        <div class="logo-badge-container me-4">
                            <img src="{{ url_for('static', filename='photos/logo3.png') }}" alt="CUZ" class="header-logo">
                        </div>
                        <div>
                            <h1 class="h2 fw-bold text-white mb-1">Welcome back, <span class="text-gold-gradient">{{ current_user.username }}!</span> ðŸ‘‹</h1>
                            <p class="text-white-50 mb-0">Intellectual Hub â€¢ Digital Archive Access</p>
                        </div>
                    </div>
                    <div class="col-md-4 text-md-end mt-3 mt-md-0">
                        <div class="session-badge">
                            <i class="fas fa-clock me-2"></i>
                            {{ current_user.last_login.strftime('%I:%M %p') if current_user.last_login else 'First Session' }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4 g-3">
        <div class="col-xl-3 col-md-6">
            <div class="stat-glass-card ocean">
                <i class="fas fa-wallet stat-icon"></i>
                <div class="stat-content">
                    <p class="stat-label">Wallet Balance</p>
                    <h2 class="stat-value">${{ "%.2f"|format(wallet.balance) if wallet else "0.00" }}</h2>
                </div>
                <a href="{{ url_for('payments.wallet') }}" class="stat-btn mt-3"><i class="fas fa-plus"></i> Add Funds</a>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stat-glass-card forest">
                <i class="fas fa-book stat-icon"></i>
                <div class="stat-content">
                    <p class="stat-label">My Books</p>
                    <h2 class="stat-value">{{ user_books|length }}</h2>
                </div>
                <a href="{{ url_for('books.my_books') }}" class="stat-btn mt-3"><i class="fas fa-eye"></i> View All</a>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stat-glass-card purple">
                <i class="fas fa-exchange-alt stat-icon"></i>
                <div class="stat-content">
                    <p class="stat-label">Transactions</p>
                    <h2 class="stat-value">{{ user_transactions|length }}</h2>
                </div>
                <a href="{{ url_for('payments.transaction_history') }}" class="stat-btn mt-3"><i class="fas fa-history"></i> History</a>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="stat-glass-card sunset">
                <i class="fas fa-book-reader stat-icon"></i>
                <div class="stat-content">
                    <p class="stat-label">Reading Streak</p>
                    <h2 class="stat-value">7 Days</h2>
                </div>
                <div class="stat-badge-mini mt-3"><i class="fas fa-fire"></i> Trending</div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-xl-8">
            <div class="content-glass-card mb-4">
                <div class="card-header-glass">
                    <h5 class="text-white mb-0"><i class="fas fa-bolt text-warning me-2"></i>Quick Actions</h5>
                </div>
                <div class="p-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <a href="{{ url_for('books.upload') }}" class="quick-action-btn">
                                <div class="action-icon blue"><i class="fas fa-upload"></i></div>
                                <div>
                                    <h6 class="text-white mb-0">Upload Resource</h6>
                                    <small class="text-white-50">Add to the collection</small>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-6">
                            <a href="{{ url_for('books.catalog') }}" class="quick-action-btn">
                                <div class="action-icon green"><i class="fas fa-search"></i></div>
                                <div>
                                    <h6 class="text-white mb-0">Browse Library</h6>
                                    <small class="text-white-50">Explore archives</small>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-glass-card">
                <div class="card-header-glass d-flex justify-content-between align-items-center">
                    <h5 class="text-white mb-0"><i class="fas fa-history text-info me-2"></i>Intellectual Activity</h5>
                    <a href="{{ url_for('payments.transaction_history') }}" class="text-gold-gradient small text-decoration-none">Full History</a>
                </div>
                <div class="p-0 table-responsive">
                    <table class="table table-dark-glass mb-0">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Action</th>
                                <th>Date</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in user_transactions[:5] %}
                            <tr>
                                <td class="text-white fw-bold">
                                    {{ transaction.book.title|truncate(25) if transaction.book else "System Resource" }}
                                </td>
                                <td>
                                    {% if transaction.transaction_type == 'purchase' %}
                                        <span class="badge bg-primary bg-opacity-25 text-primary"><i class="fas fa-shopping-cart me-1"></i> Purchased</span>
                                    {% elif transaction.transaction_type == 'upload' %}
                                        <span class="badge bg-success bg-opacity-25 text-success"><i class="fas fa-cloud-upload-alt me-1"></i> Uploaded</span>
                                    {% else %}
                                        <span class="badge bg-info bg-opacity-25 text-info"><i class="fas fa-book-open me-1"></i> Opened</span>
                                    {% endif %}
                                </td>
                                <td class="text-white-50 small">{{ transaction.created_at.strftime('%b %d, %H:%M') }}</td>
                                <td>
                                    {% if transaction.amount and transaction.amount > 0 %}
                                        <span class="text-danger fw-bold">-${{ "%.2f"|format(transaction.amount) }}</span>
                                    {% else %}
                                        <span class="text-success fw-bold">FREE</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center py-5 text-white-50">No activity logged in the archives yet.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-xl-4">
            <div class="content-glass-card p-4 text-center mb-4">
                <h5 class="text-white mb-4">Reading Goal</h5>
                <div class="reading-progress-container">
                    <svg viewBox="0 0 36 36" class="circular-chart">
                        <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        <path class="circle" stroke-dasharray="65, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        <text x="18" y="20.35" class="percentage">65%</text>
                    </svg>
                </div>
                <p class="text-white mt-3 mb-1">13 / 20 Books</p>
                <small class="text-white-50">You're on track this month!</small>
            </div>

            <div class="content-glass-card p-4 mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="text-white mb-0"><i class="fas fa-feather text-gold me-2"></i>Scholar's Notes</h5>
                    <small id="saveStatus" class="text-success opacity-0" style="transition: 0.5s; font-size: 0.7rem;">SAVED</small>
                </div>
                <textarea id="scholarNotes" class="notes-area" placeholder="Jot down book IDs, quotes, or reminders..."></textarea>
                <div class="mt-2 text-end">
                    <small class="text-white-50" style="font-size: 0.7rem;">Autosaves to your browser</small>
                </div>
            </div>

            <div class="content-glass-card p-4">
                <h5 class="text-white mb-3"><i class="fas fa-chart-line text-gold me-2"></i>Trending Archives</h5>
                <div class="trending-list">
                    <div class="trending-item mb-3">
                        <span class="rank">01</span>
                        <div class="ms-3">
                            <p class="text-white mb-0 small fw-bold">Jurisprudence Vol II</p>
                            <small class="text-white-50">14 Scholars reading</small>
                        </div>
                    </div>
                    <div class="trending-item">
                        <span class="rank">02</span>
                        <div class="ms-3">
                            <p class="text-white mb-0 small fw-bold">Macroeconomics 2024</p>
                            <small class="text-white-50">8 New requests</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    :root {
        --glass-bg: rgba(10, 15, 30, 0.7);
        --glass-border: rgba(255, 255, 255, 0.12);
        --gold: #d4af37;
    }

    body { background: #020617; }

    .bg-system { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; }
    .bg-image { width: 100%; height: 100%; background-size: cover; background-position: center; filter: brightness(0.6) contrast(1.2); }
    .bg-overlay-glass { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, transparent 0%, rgba(2, 6, 23, 0.8) 100%); }
    .dashboard-relative { position: relative; z-index: 10; }

    .header-glass-card, .content-glass-card, .stat-glass-card {
        background: var(--glass-bg);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(0,0,0,0.4);
    }

    .logo-badge-container { background: white; padding: 10px; border-radius: 15px; box-shadow: 0 0 20px rgba(212, 175, 55, 0.3); }
    .header-logo { width: 45px; }
    .text-gold-gradient { background: linear-gradient(to right, #fff, var(--gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .session-badge { background: rgba(255,255,255,0.1); color: white; padding: 8px 16px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.1); display: inline-block; }

    .stat-glass-card { padding: 24px; position: relative; overflow: hidden; transition: 0.3s; }
    .stat-icon { position: absolute; right: -10px; top: -10px; font-size: 5rem; opacity: 0.1; color: white; }
    .stat-label { color: rgba(255,255,255,0.6); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; }
    .stat-value { color: white; font-weight: 800; margin: 0; }
    .stat-btn { display: block; width: 100%; text-align: center; background: rgba(255,255,255,0.05); color: white; text-decoration: none; padding: 6px; border-radius: 10px; font-size: 0.75rem; border: 1px solid rgba(255,255,255,0.1); }
    
    .stat-glass-card.ocean { border-left: 4px solid #3b82f6; }
    .stat-glass-card.forest { border-left: 4px solid #10b981; }
    .stat-glass-card.purple { border-left: 4px solid #8b5cf6; }
    .stat-glass-card.sunset { border-left: 4px solid #f59e0b; }

    .quick-action-btn { display: flex; align-items: center; padding: 15px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 15px; text-decoration: none; transition: 0.2s; }
    .quick-action-btn:hover { background: rgba(255,255,255,0.08); border-color: var(--gold); }
    .action-icon { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 1.2rem; }
    .action-icon.blue { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    .action-icon.green { background: rgba(16, 185, 129, 0.2); color: #10b981; }

    .table-dark-glass { color: rgba(255,255,255,0.7); }
    .table-dark-glass thead th { border-top: none; border-bottom: 1px solid rgba(255,255,255,0.1); padding: 15px; font-size: 0.8rem; }
    .table-dark-glass td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); vertical-align: middle; }
    .card-header-glass { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }

    .notes-area { background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; width: 100%; height: 150px; color: white; padding: 12px; font-size: 0.9rem; resize: none; outline: none; transition: 0.3s; }
    .notes-area:focus { border-color: var(--gold); background: rgba(0, 0, 0, 0.4); }
    .trending-item { display: flex; align-items: center; }
    .rank { font-weight: 900; color: var(--gold); font-size: 1.1rem; opacity: 0.6; }

    .circular-chart { display: block; margin: 10px auto; max-width: 150px; }
    .circle-bg { fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 2.8; }
    .circle { fill: none; stroke-width: 2.8; stroke-linecap: round; stroke: var(--gold); }
    .percentage { fill: white; font-size: 0.5rem; text-anchor: middle; font-weight: bold; }
</style>

<script>
    const notesInput = document.getElementById('scholarNotes');
    const saveStatus = document.getElementById('saveStatus');

    window.onload = () => {
        notesInput.value = localStorage.getItem('hub_scholar_notes') || '';
    };

    notesInput.addEventListener('input', () => {
        localStorage.setItem('hub_scholar_notes', notesInput.value);
        saveStatus.classList.add('opacity-100');
        setTimeout(() => {
            saveStatus.classList.remove('opacity-100');
        }, 1000);
    });
</script>
{% endblock %}