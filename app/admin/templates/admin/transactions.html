{% extends "base.html" %}

{% block content %}
<div class="bg-system">
    <div class="bg-image" style="background-image: url('{{ url_for('static', filename='photos/admin_bg.png') }}');"></div>
    <div class="bg-overlay-glass"></div>
</div>

<div class="container-fluid py-5 dashboard-relative">
    <div class="row align-items-center mb-5">
        <div class="col-md-6">
            <h1 class="page-title text-white">Financial <br><span class="text-gold-gradient">Ledger</span></h1>
            <p class="text-white-50">Monitoring academic exchange and resource circulation.</p>
        </div>
        <div class="col-md-6 text-md-end">
            <div class="ledger-meta">
                <span class="badge-glass-gold px-4 py-2">
                    <i class="fas fa-database me-2"></i>{{ transactions.total }} Records in Archive
                </span>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="stat-glass-card success">
                <div class="stat-icon"><i class="fas fa-vault"></i></div>
                <div class="stat-content">
                    <span class="stat-label">Total Volume</span>
                    <h3 class="stat-value">${{ "%.2f"|format(total_volume) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-glass-card info">
                <div class="stat-icon"><i class="fas fa-hand-holding-usd"></i></div>
                <div class="stat-content">
                    <span class="stat-label">Total Purchases</span>
                    <h3 class="stat-value">{{ purchase_count }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-glass-card warning">
                <div class="stat-icon"><i class="fas fa-clock"></i></div>
                <div class="stat-content">
                    <span class="stat-label">Active Rentals</span>
                    <h3 class="stat-value">{{ rental_count }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-glass-card primary">
                <div class="stat-icon"><i class="fas fa-check-double"></i></div>
                <div class="stat-content">
                    <span class="stat-label">Settled Flows</span>
                    <h3 class="stat-value">{{ completed_count }}</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="ledger-container">
        <div class="ledger-header d-flex justify-content-between align-items-center p-4">
            <h5 class="text-white mb-0 font-playfair"><i class="fas fa-list-ul me-2 text-gold"></i>Audit Trail</h5>
            <div class="ledger-actions">
                <button class="btn btn-sm btn-outline-light rounded-pill px-3 me-2" onclick="window.print()">
                    <i class="fas fa-print me-1"></i>Print Ledger
                </button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-custom-glass mb-0">
                <thead>
                    <tr>
                        <th>Identifier</th>
                        <th>Temporal Mark</th>
                        <th>Scholar</th>
                        <th>Volume</th>
                        <th>Flow Type</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in transactions.items %}
                    <tr>
                        <td class="text-white-50 small font-monospace">#{{ transaction.transaction_id|truncate(8, True, '') }}</td>
                        <td>
                            <div class="d-flex flex-column">
                                <span class="text-white small">{{ transaction.created_at.strftime('%d %b %Y') }}</span>
                                <span class="tiny text-white-50">{{ transaction.created_at.strftime('%H:%M') }}</span>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar-sm me-2">{{ transaction.user.username[0]|upper }}</div>
                                <div>
                                    <div class="text-white small fw-bold">{{ transaction.user.username }}</div>
                                    <div class="tiny text-white-50">{{ transaction.user.email }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="text-gold small fw-bold text-truncate" style="max-width: 150px;">{{ transaction.book.title }}</div>
                            <div class="tiny text-white-50">by {{ transaction.book.author }}</div>
                        </td>
                        <td>
                            <span class="type-badge {{ transaction.transaction_type }}">
                                {{ transaction.transaction_type|upper }}
                            </span>
                        </td>
                        <td>
                            <span class="text-white fw-bold">${{ "%.2f"|format(transaction.amount) }}</span>
                        </td>
                        <td>
                            <span class="status-dot {{ transaction.status }}"></span>
                            <span class="tiny text-uppercase text-white-50">{{ transaction.status }}</span>
                        </td>
                        <td>
                            <div class="btn-group">
                                <a href="{{ url_for('books.book_detail', book_id=transaction.book.book_id) }}" class="btn-action-glass" title="View Book">
                                    <i class="fas fa-book"></i>
                                </a>
                                <a href="{{ url_for('admin.users', email=transaction.user.email) }}" class="btn-action-glass" title="View User">
                                    <i class="fas fa-user-graduate"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% if transactions.pages > 1 %}
    <div class="d-flex justify-content-center mt-5">
        <nav class="pagination-glass">
            {% if transactions.has_prev %}
                <a href="{{ url_for('admin.transactions', page=transactions.prev_num) }}" class="pag-item"><i class="fas fa-chevron-left"></i></a>
            {% endif %}
            
            <span class="pag-current">Journal {{ transactions.page }} of {{ transactions.pages }}</span>

            {% if transactions.has_next %}
                <a href="{{ url_for('admin.transactions', page=transactions.next_num) }}" class="pag-item"><i class="fas fa-chevron-right"></i></a>
            {% endif %}
        </nav>
    </div>
    {% endif %}
</div>

<style>
    :root {
        --gold: #d4af37;
        --glass-bg: rgba(255, 255, 255, 0.03);
        --border-glass: rgba(255, 255, 255, 0.1);
    }

    /* Stat Cards */
    .stat-glass-card {
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border: 1px solid var(--border-glass);
        padding: 25px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        transition: 0.3s;
    }
    .stat-glass-card:hover { transform: translateY(-5px); border-color: var(--gold); }
    .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-right: 20px; }
    
    .stat-glass-card.success .stat-icon { background: rgba(16, 185, 129, 0.1); color: #10b981; }
    .stat-glass-card.info .stat-icon { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
    .stat-glass-card.warning .stat-icon { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
    .stat-glass-card.primary .stat-icon { background: rgba(212, 175, 55, 0.1); color: var(--gold); }

    .stat-label { font-size: 0.75rem; text-transform: uppercase; color: rgba(255,255,255,0.5); letter-spacing: 1px; }
    .stat-value { color: white; margin-bottom: 0; font-weight: 700; }

    /* Ledger Table */
    .ledger-container {
        background: rgba(10, 15, 30, 0.7);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        border: 1px solid var(--border-glass);
        overflow: hidden;
    }

    .table-custom-glass { color: white; vertical-align: middle; }
    .table-custom-glass thead th {
        background: rgba(255,255,255,0.05);
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 2px;
        color: var(--gold);
        border: none;
        padding: 20px;
    }
    .table-custom-glass tbody td { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); }

    .avatar-sm {
        width: 32px; height: 32px; background: var(--gold); color: black;
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-weight: bold; font-size: 0.8rem;
    }

    /* Status & Types */
    .type-badge { font-size: 0.6rem; padding: 4px 10px; border-radius: 6px; font-weight: 800; }
    .type-badge.purchase { background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.2); }
    .type-badge.rental { background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.2); }

    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    .status-dot.completed { background: #10b981; box-shadow: 0 0 10px #10b981; }
    .status-dot.pending { background: #f59e0b; }

    /* Actions */
    .btn-action-glass {
        width: 35px; height: 35px; background: rgba(255,255,255,0.05); color: white;
        display: inline-flex; align-items: center; justify-content: center;
        border-radius: 8px; margin: 0 2px; transition: 0.3s;
    }
    .btn-action-glass:hover { background: var(--gold); color: black; transform: scale(1.1); }

    /* Pagination */
    .pagination-glass {
        background: var(--glass-bg);
        border: 1px solid var(--border-glass);
        padding: 10px 25px;
        border-radius: 50px;
        display: flex;
        align-items: center;
    }
    .pag-item { color: var(--gold); font-size: 1.1rem; padding: 0 10px; transition: 0.3s; }
    .pag-item:hover { color: white; }
    .pag-current { color: white; font-weight: bold; border-left: 1px solid var(--border-glass); border-right: 1px solid var(--border-glass); padding: 0 20px; margin: 0 10px; }

    .tiny { font-size: 0.65rem; }
</style>
{% endblock %}